//@version=5
indicator("FX Channel Scanner (LR Channel) – H4 default", overlay=false, timeframe="", max_lines_count=500, max_labels_count=500)

// ===== Inputs =====
tf             = input.timeframe("240", "Scan timeframe (e.g., 240=H4, 60=H1, D=W1)")
length         = input.int(100, "Lookback bars (channel fit)", minval=50, maxval=500)
stdevMult      = input.float(2.0, "Channel width (stdev multiplier)", minval=0.5, maxval=4.0, step=0.1)
insideBarsReq  = input.int(80, "Min % bars inside channel (0-100)", minval=50, maxval=100)
r2Min          = input.float(0.25, "Min R² (trend linearity)", minval=0.0, maxval=1.0, step=0.05)
atrQuietPct    = input.float(3.0, "Max ATR% (quietness filter)", minval=0.0, maxval=10.0, step=0.1)
recentBars     = input.int(50, "Bars to test inside-channel", minval=20, maxval=300)
showOnlyHits   = input.bool(true, "Show only symbols in a channel")
provider       = input.string("OANDA:", "Symbol prefix (FOREXCOM:, FX_IDC:, OANDA:, etc.)")

// ===== Symbol Universe =====
// Add/remove to taste. Keep majors, minors, and a few exotics. You can paste hundreds if your plan permits.
syms = array.from(
    provider + "EURUSD", provider + "GBPUSD", provider + "USDJPY", provider + "USDCHF", provider + "USDCAD", provider + "AUDUSD", provider + "NZDUSD",
    provider + "EURGBP", provider + "EURJPY", provider + "EURAUD", provider + "EURNZD", provider + "EURCHF", provider + "EURCAD",
    provider + "GBPJPY", provider + "GBPAUD", provider + "GBPNZD", provider + "GBPCHF", provider + "GBPCAD",
    provider + "AUDJPY", provider + "AUDNZD", provider + "AUDCAD", provider + "AUDCHF",
    provider + "NZDJPY", provider + "NZDCAD", provider + "NZDCHF",
    provider + "CADJPY", provider + "CADCHF", provider + "CHFJPY",
    provider + "USDSEK", provider + "USDNOK", provider + "USDSGD", provider + "USDZAR", provider + "USDMXN"
)

// ===== Utilities =====
f_pctInsideChannel = (h, l, mid, rng) =>
    // % of bars whose high/low sit within [mid - rng, mid + rng]
    total = 0
    inside = 0
    for i = 0 to recentBars - 1
        m  = mid[i]
        r  = rng[i]
        hi = h[i]
        lo = l[i]
        total += 1
        inside += (hi <= m + r and lo >= m - r) ? 1 : 0
    pct = total > 0 ? (inside * 100.0) / total : 0.0
    pct

// ===== Table =====
var table t = table.new(position.top_right, 5, 200, border_width=1)
if barstate.isfirst
    table.cell(t, 0, 0, "Symbol", text_color=color.white, bgcolor=color.new(color.blue, 0))
    table.cell(t, 1, 0, "Slope",  text_color=color.white, bgcolor=color.new(color.blue, 0))
    table.cell(t, 2, 0, "% Inside",text_color=color.white, bgcolor=color.new(color.blue, 0))
    table.cell(t, 3, 0, "R²",      text_color=color.white, bgcolor=color.new(color.blue, 0))
    table.cell(t, 4, 0, "ATR%",    text_color=color.white, bgcolor=color.new(color.blue, 0))

row = 1
anyHit = false

for i = 0 to array.size(syms) - 1
    sym = array.get(syms, i)
    o = request.security(sym, tf, open)
    h = request.security(sym, tf, high)
    l = request.security(sym, tf, low)
    c = request.security(sym, tf, close)

    // Linear regression midline & width
    mid   = ta.linreg(c, length, 0)
    sd    = ta.stdev(c, length)
    range = sd * stdevMult

    // R² of price ~ time (bar_index proxy): how "channel-like" the trend is
    r2 = math.pow(ta.correlation(c, float(bar_index), length), 2)

    // Quietness (optional): ATR% of price
    atr = ta.atr(14)
    atrPct = (atr / c) * 100.0

    // % bars inside channel over recent window
    pctInside = f_pctInsideChannel(h, l, mid, range)

    // Slope (up/down/flat) from midline today vs midline length bars ago
    slopeVal = mid - mid[length - 1]
    slopeTxt = slopeVal > 0 ? "Up" : (slopeVal < 0 ? "Down" : "Flat")

    inChannel = (pctInside >= insideBarsReq) and (r2 >= r2Min) and (atrPct <= atrQuietPct)

    if (showOnlyHits and inChannel) or (not showOnlyHits)
        anyHit := anyHit or inChannel
        bg = inChannel ? color.new(color.green, 80) : color.new(color.yellow, 85)
        table.cell(t, 0, row, sym, bgcolor=bg)
        table.cell(t, 1, row, slopeTxt)
        table.cell(t, 2, row, str.tostring(pctInside, format.mintick) + "%")
        table.cell(t, 3, row, str.tostring(r2, format.mintick))
        table.cell(t, 4, row, str.tostring(atrPct, format.mintick))
        row += 1

// Simple plot dot to allow alerting when at least one hit exists
plotchar(anyHit, char="●", location=location.top, color=color.green, size=size.tiny, title="Any Channel Hits")
alertcondition(anyHit, "Channel Scanner Hit", "One or more FX pairs are currently channeling per scanner filters.")
