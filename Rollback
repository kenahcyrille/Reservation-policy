---
- name: Full Rollback: DNF Transaction + Configuration Snapshot
  hosts: all
  become: yes

  vars:
    backup_root: /var/backups/ansible
    restore_source: "{{ backup_root }}/{{ inventory_hostname }}/latest"
    log_file: /var/log/hpc_installer.log
    target_dnf_id: ""    # optional override: ansible-playbook rollback.yml -e "target_dnf_id=25"

  tasks:
    - name: Check if DNF exists on system
      stat:
        path: /usr/bin/dnf
      register: dnf_exists

    - name: Determine DNF transaction ID to use
      when: dnf_exists.stat.exists
      block:
        - name: Get last completed DNF transaction ID
          shell: |
            dnf history list | awk "NR==3 {print \$1}"
          register: dnf_last_id
          changed_when: false

        - name: Set rollback target ID (manual override or latest)
          set_fact:
            rollback_dnf_id: "{{ target_dnf_id | default(dnf_last_id.stdout, true) }}"

        - name: Display chosen DNF transaction ID
          debug:
            msg: "Rollback target DNF transaction ID for {{ inventory_hostname }}: {{ rollback_dnf_id }}"

    - name: Rollback DNF packages to chosen transaction
      when: dnf_exists.stat.exists and rollback_dnf_id | length > 0
      block:
        - name: Execute DNF rollback
          shell: |
            dnf -y history undo {{ rollback_dnf_id }}
          args:
            warn: false
          register: dnf_rollback
          ignore_errors: yes

        - name: Log DNF rollback
          lineinfile:
            path: "{{ log_file }}"
            create: yes
            line: "[{{ ansible_date_time.iso8601 }}] DNF rollback to ID {{ rollback_dnf_id }} executed on {{ inventory_hostname }}"

      rescue:
        - name: Warn if DNF rollback failed
          debug:
            msg: "DNF rollback failed or not applicable on {{ inventory_hostname }}"

    - name: Verify configuration snapshot availability
      stat:
        path: "{{ restore_source }}"
      register: snapshot_state

    - name: Restore configuration snapshot
      when: snapshot_state.stat.exists
      block:
        - name: Restore configuration files
          copy:
            src: "{{ restore_source }}/"
            dest: /
            owner: root
            group: root
            mode: preserve
            force: yes
            remote_src: yes

        - name: Log configuration restoration
          lineinfile:
            path: "{{ log_file }}"
            create: yes
            line: "[{{ ansible_date_time.iso8601 }}] Configuration snapshot restored for {{ inventory_hostname }}"

    - name: Confirm rollback completion
      debug:
        msg: >
          Rollback completed on {{ inventory_hostname }}.
          DNF transaction {{ rollback_dnf_id | default('N/A') }} undone (if applicable) and configuration snapshot restored.
